<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}KI Girl Manager{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
    /* ==================== LOADING SCREEN ==================== */
    #ki-loadscreen {
        position: fixed; inset: 0; z-index: 99999;
        display: flex; flex-direction: column;
        align-items: center; justify-content: center;
        background: #0a0e1a;
        transition: opacity .5s ease, transform .5s ease;
    }
    #ki-loadscreen.hide {
        opacity: 0; transform: scale(1.05);
        pointer-events: none;
    }
    #ki-loadscreen .ls-logo {
        font-size: 52px;
        animation: ls-pulse 1.6s ease-in-out infinite;
        margin-bottom: 22px;
        filter: drop-shadow(0 0 18px rgba(124,58,237,.6));
    }
    #ki-loadscreen .ls-title {
        font-family: system-ui, -apple-system, sans-serif;
        font-size: 18px; font-weight: 600;
        color: #e2e8f0; letter-spacing: .5px;
        margin-bottom: 28px;
    }
    #ki-loadscreen .ls-bar-track {
        width: 240px; height: 3px;
        background: rgba(255,255,255,.08);
        border-radius: 3px; overflow: hidden;
        position: relative;
    }
    #ki-loadscreen .ls-bar {
        position: absolute; inset: 0;
        width: 40%; height: 100%;
        border-radius: 3px;
        background: linear-gradient(90deg, #7c3aed, #a78bfa, #7c3aed);
        background-size: 200% 100%;
        animation: ls-slide 1.2s ease-in-out infinite;
    }
    #ki-loadscreen .ls-particles {
        position: absolute; inset: 0; overflow: hidden;
        pointer-events: none;
    }
    #ki-loadscreen .ls-p {
        position: absolute;
        width: 2px; height: 2px;
        background: rgba(124,58,237,.5);
        border-radius: 50%;
        animation: ls-float linear infinite;
    }
    @keyframes ls-pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.12); }
    }
    @keyframes ls-slide {
        0% { transform: translateX(-100%); background-position: 0% 0; }
        50% { background-position: 100% 0; }
        100% { transform: translateX(350%); background-position: 0% 0; }
    }
    @keyframes ls-float {
        0% { transform: translateY(100vh) scale(0); opacity: 0; }
        10% { opacity: 1; }
        90% { opacity: 1; }
        100% { transform: translateY(-10vh) scale(1); opacity: 0; }
    }
    /* Light theme loading screen */
    [data-theme="light"] #ki-loadscreen {
        background: #e8ecf4;
    }
    [data-theme="light"] #ki-loadscreen .ls-title {
        color: #1e293b;
    }
    [data-theme="light"] #ki-loadscreen .ls-bar-track {
        background: rgba(0,0,0,.08);
    }
    </style>
</head>
<body>
    <!-- ==================== LOADING SCREEN ==================== -->
    <div id="ki-loadscreen">
        <div class="ls-particles" id="ls-particles"></div>
        <div class="ls-logo">üé≠</div>
        <div class="ls-title">Wird geladen ‚Ä¶</div>
        <div class="ls-bar-track"><div class="ls-bar"></div></div>
    </div>
    <script>
    // Spawn floating particles
    (function(){
        var c = document.getElementById('ls-particles');
        for(var i=0;i<25;i++){
            var p = document.createElement('div');
            p.className='ls-p';
            p.style.left = Math.random()*100+'%';
            p.style.animationDuration = (3+Math.random()*5)+'s';
            p.style.animationDelay = Math.random()*4+'s';
            p.style.width = p.style.height = (1+Math.random()*3)+'px';
            c.appendChild(p);
        }
    })();
    </script>
    <script>
        // Apply saved theme immediately to prevent flash
        (function() {
            const saved = localStorage.getItem('ki-girl-theme') || 'dark';
            if (saved === 'light') document.documentElement.setAttribute('data-theme', 'light');
        })();
        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const next = current === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', next === 'light' ? 'light' : '');
            if (next === 'dark') document.documentElement.removeAttribute('data-theme');
            localStorage.setItem('ki-girl-theme', next);
            _updateThemeUI(next);
        }
        function _updateThemeUI(theme) {
            const icon = document.getElementById('theme-icon');
            const label = document.getElementById('theme-label');
            if (icon) icon.textContent = theme === 'light' ? '‚òÄÔ∏è' : 'üåô';
            if (label) label.textContent = theme === 'light' ? 'Light Mode' : 'Dark Mode';
        }
        document.addEventListener('DOMContentLoaded', function() {
            _updateThemeUI(localStorage.getItem('ki-girl-theme') || 'dark');
        });
    </script>
    <div class="layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>üé≠ KI Girl</h1>
                <p class="sidebar-subtitle">Project Manager</p>
            </div>
            
            <nav class="sidebar-nav">
                <!-- Home / Instanzen -->
                <a href="/" class="nav-item {% if request.path == '/' %}active{% endif %}">
                    <span class="nav-icon">üè†</span>
                    <span class="nav-label">Startseite</span>
                </a>
                
                <!-- Current Instance Navigation (if on instance page) -->
                {% if '/instance/' in request.path %}
                    {% set instance_match = request.path.split('/')[2] if request.path.startswith('/instance/') else None %}
                    {% if instance_match %}
                    <div class="nav-separator"></div>
                    
                    <a href="/instance/{{ instance_match }}/dashboard" class="nav-item {% if '/dashboard' in request.path %}active{% endif %}">
                        <span class="nav-icon">üìä</span>
                        <span class="nav-label">Dashboard</span>
                    </a>
                    <a href="/instance/{{ instance_match }}/services" class="nav-item {% if '/services' in request.path %}active{% endif %}">
                        <span class="nav-icon">‚öôÔ∏è</span>
                        <span class="nav-label">Services</span>
                    </a>
                    <a href="/instance/{{ instance_match }}/config" class="nav-item {% if '/config' in request.path and '/configs' not in request.path %}active{% endif %}">
                        <span class="nav-icon">üß©</span>
                        <span class="nav-label">Instance Config</span>
                    </a>
                    
                    <div class="nav-separator"></div>
                    {% endif %}
                {% endif %}
                
                <!-- Global Pages -->
                <a href="/configs" class="nav-item {% if request.path.startswith('/configs') %}active{% endif %}">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span class="nav-label">Einstellungen</span>
                </a>
                
                <a href="/characters" class="nav-item {% if request.path.startswith('/characters') %}active{% endif %}">
                    <span class="nav-icon">üé≠</span>
                    <span class="nav-label">Characters</span>
                </a>
                
                <div class="nav-separator"></div>
                
                <!-- External Tools -->
                <a href="http://localhost:8050" target="_blank" class="nav-item">
                    <span class="nav-icon">üé¨</span>
                    <span class="nav-label">Szenario Maker</span>
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" onclick="toggleTheme()">
                    <span class="theme-toggle-icon" id="theme-icon">üåô</span>
                    <span id="theme-label">Dark Mode</span>
                </button>
                <div class="status-indicator">
                    <span class="status-dot"></span>
                    <span class="status-text">Manager l√§uft</span>
                </div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <header class="page-header">
                <div class="page-title">
                    <h2>{% block page_title %}Dashboard{% endblock %}</h2>
                    <p class="page-subtitle">{% block page_subtitle %}√úbersicht aller Services{% endblock %}</p>
                </div>
                <div class="page-actions">
                    {% block page_actions %}{% endblock %}
                </div>
            </header>
            
            <div class="page-content">
                {% block content %}{% endblock %}
            </div>
        </main>
    </div>
    
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script src="{{ url_for('static', filename='js/simple_fields.js') }}"></script>
    {% block scripts %}{% endblock %}
    <script>
    // Dismiss loading screen when page fully loaded
    (function(){
        function dismiss(){
            var ls = document.getElementById('ki-loadscreen');
            if(!ls) return;
            ls.classList.add('hide');
            setTimeout(function(){ ls.remove(); }, 600);
        }
        if(document.readyState === 'complete') dismiss();
        else window.addEventListener('load', dismiss);
        // Safety fallback ‚Äî never show longer than 4s
        setTimeout(dismiss, 4000);
    })();
    // Intercept link clicks to show loading screen on navigation
    document.addEventListener('click', function(e){
        var a = e.target.closest('a[href]');
        if(!a) return;
        var href = a.getAttribute('href');
        // Skip external, anchor, JS, new-tab links
        if(!href || href.startsWith('#') || href.startsWith('javascript:')
           || a.target === '_blank' || a.hasAttribute('download')
           || href.startsWith('http') && !href.startsWith(location.origin)) return;
        // Show loading screen for internal navigation
        var ls = document.getElementById('ki-loadscreen');
        if(!ls){
            // Recreate if removed
            ls = document.createElement('div');
            ls.id = 'ki-loadscreen';
            ls.innerHTML = '<div class="ls-particles"></div><div class="ls-logo">üé≠</div><div class="ls-title">Wird geladen ‚Ä¶</div><div class="ls-bar-track"><div class="ls-bar"></div></div>';
            document.body.appendChild(ls);
        }
        ls.classList.remove('hide');
        ls.style.opacity = '1';
        ls.style.transform = 'scale(1)';
    });
    </script>
</body>
</html>
