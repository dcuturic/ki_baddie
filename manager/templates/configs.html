{% extends "base.html" %}

{% block page_title %}Configs{% endblock %}
{% block page_subtitle %}Zentrale Konfigurationsverwaltung{% endblock %}

{% block content %}
<div class="configs-layout">
    <!-- Config Selector -->
    <div class="config-selector">
        <h3>Config-Dateien</h3>
        <div class="config-list">
            <div class="config-item active" onclick="selectConfig('manager')">
                <span class="config-icon">âš™ï¸</span>
                <span class="config-name">Manager</span>
            </div>
            <div class="config-item" onclick="selectConfig('ki_chat')">
                <span class="config-icon">ğŸ’¬</span>
                <span class="config-name">KI Chat</span>
            </div>
            <div class="config-item" onclick="selectConfig('main_server')">
                <span class="config-icon">ğŸ¯</span>
                <span class="config-name">Main Server</span>
            </div>
            <div class="config-item" onclick="selectConfig('text_to_speech')">
                <span class="config-icon">ğŸ”Š</span>
                <span class="config-name">Text-to-Speech</span>
            </div>
            <div class="config-item" onclick="selectConfig('vroid_poser')">
                <span class="config-icon">ğŸ­</span>
                <span class="config-name">VRoid Poser</span>
            </div>
            <div class="config-item" onclick="selectConfig('vroid_emotion')">
                <span class="config-icon">ğŸ˜Š</span>
                <span class="config-name">VRoid Emotion</span>
            </div>
        </div>
    </div>
    
    <!-- Config Editor -->
    <div class="config-editor">
        <div class="editor-header">
            <h3 id="editor-title">Manager Config</h3>
            <div class="editor-actions">
                <button class="btn btn-secondary" onclick="reloadConfig()">
                    ğŸ”„ Neu laden
                </button>
                <button class="btn btn-success" onclick="saveConfig()">
                    ğŸ’¾ Speichern
                </button>
            </div>
        </div>
        
        <div class="editor-body">
            <textarea id="config-editor" class="code-editor" spellcheck="false"></textarea>
        </div>
        
        <div class="editor-footer">
            <div class="editor-info">
                <span class="info-item">
                    <strong>Pfad:</strong> <code id="config-path">config.json</code>
                </span>
                <span class="info-item">
                    <strong>Zeilen:</strong> <span id="line-count">0</span>
                </span>
                <span class="info-item">
                    <strong>GrÃ¶ÃŸe:</strong> <span id="file-size">0 KB</span>
                </span>
            </div>
        </div>
    </div>
    
    <!-- Config Preview/Validation -->
    <div class="config-info">
        <h3>Informationen</h3>
        
        <div class="info-section">
            <h4>JSON Validation</h4>
            <div id="validation-status" class="status-ok">
                âœ… GÃ¼ltiges JSON
            </div>
        </div>
        
        <div class="info-section">
            <h4>Wichtige Parameter</h4>
            <div id="config-params" class="params-list">
                <!-- Will be populated -->
            </div>
        </div>
        
        <div class="info-section">
            <h4>Ã„nderungen</h4>
            <div class="changes-info">
                <p class="info-text">
                    âš ï¸ Nach Ã„nderungen Service neu starten!
                </p>
                <button class="btn btn-sm btn-primary" onclick="restartService()">
                    ğŸ”„ Service neu starten
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Auto-validate JSON on input
document.addEventListener('DOMContentLoaded', () => {
    const editor = document.getElementById('config-editor');
    if (editor) {
        editor.addEventListener('input', () => {
            validateConfigJSON();
            updateEditorInfo();
        });
        
        // Load initial config
        selectConfig('manager');
    }
});

// Validate JSON in editor
function validateConfigJSON() {
    const editor = document.getElementById('config-editor');
    const statusEl = document.getElementById('validation-status');
    
    if (!statusEl || !editor) return;
    
    try {
        const parsed = JSON.parse(editor.value);
        statusEl.className = 'status-ok';
        statusEl.textContent = 'âœ… GÃ¼ltiges JSON';
        
        // Show important keys
        const paramsEl = document.getElementById('config-params');
        if (paramsEl) {
            paramsEl.innerHTML = '';
            const topKeys = Object.keys(parsed).slice(0, 8);
            topKeys.forEach(key => {
                const param = document.createElement('div');
                param.className = 'param-item';
                param.innerHTML = `<strong>${key}:</strong> <code>${typeof parsed[key]}</code>`;
                paramsEl.appendChild(param);
            });
        }
    } catch (e) {
        statusEl.className = 'status-error';
        statusEl.textContent = 'âŒ Fehler: ' + e.message;
        
        const paramsEl = document.getElementById('config-params');
        if (paramsEl) {
            paramsEl.innerHTML = '<div class="param-item" style="color: var(--accent-danger);">JSON-Fehler beheben!</div>';
        }
    }
}

// Update editor info (lines, size)
function updateEditorInfo() {
    const editor = document.getElementById('config-editor');
    if (!editor) return;
    
    const lines = editor.value.split('\n').length;
    const size = (new Blob([editor.value]).size / 1024).toFixed(2);
    
    const lineEl = document.getElementById('line-count');
    const sizeEl = document.getElementById('file-size');
    if (lineEl) lineEl.textContent = lines;
    if (sizeEl) sizeEl.textContent = size + ' KB';
}

// Override selectConfig to use main.js version with additional validation
const originalSelectConfig = selectConfig;
async function selectConfig(configName) {
    const editor = document.getElementById('config-editor');
    if (editor && editor.value !== '') {
        try {
            const currentConfig = JSON.parse(editor.value);
            const newConfig = await getConfig(configName);
            if (JSON.stringify(currentConfig) !== JSON.stringify(newConfig)) {
                if (!confirm('Ungespeicherte Ã„nderungen gehen verloren. Fortfahren?')) {
                    return;
                }
            }
        } catch (e) {
            // If current isn't valid JSON, just continue
        }
    }
    
    // Update UI
    document.querySelectorAll('.config-item').forEach(item => {
        item.classList.remove('active');
    });
    if (event && event.target) {
        event.target.closest('.config-item').classList.add('active');
    }
    
    // Load new config using main.js function
    currentEditingConfig = configName;
    const config = await getConfig(configName);
    const names = {
        'manager': 'Manager Config',
        'ki_chat': 'KI Chat Config',
        'main_server': 'Main Server Config',
        'text_to_speech': 'Text-to-Speech Config',
        'vroid_poser': 'VRoid Poser Config',
        'vroid_emotion': 'VRoid Emotion Config'
    };
    
    editor.value = JSON.stringify(config, null, 2);
    document.getElementById('editor-title').textContent = names[configName] || configName;
    
    const serviceNames = {
        'manager': 'manager/config.json',
        'ki_chat': 'ki_chat/config.json',
        'main_server': 'main_server/config.json',
        'text_to_speech': 'textToSpeech/config.json',
        'vroid_poser': 'VroidPoser/config.json',
        'vroid_emotion': 'VroidEmotion/config.json'
    };
    document.getElementById('config-path').textContent = serviceNames[configName] || 'config.json';
    
    updateEditorInfo();
    validateConfigJSON();
}

// Custom notification style for configs
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => notification.classList.add('show'), 10);
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}
</script>
{% endblock %}
