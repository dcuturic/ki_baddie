{% extends "base.html" %}

{% block page_title %}{{ instance.name }} - Config{% endblock %}
{% block page_subtitle %}Service-Konfigurationen f√ºr diese Instanz bearbeiten{% endblock %}

{% block page_actions %}
<div style="display: flex; gap: 1rem; align-items: center;">
    <select id="instanceSwitcher" onchange="switchToInstance(this.value)" style="padding: 0.75rem 1rem; border-radius: 6px; border: 2px solid var(--accent-primary); background: var(--bg-secondary); color: var(--text-primary); cursor: pointer;">
        <option value="">-- Instanz wechseln --</option>
        {% for inst in instances %}
        <option value="{{ inst.filename }}" {% if inst.filename == instance_name %}selected{% endif %}>
            {{ inst.name }}
        </option>
        {% endfor %}
    </select>
    <a href="/instance/{{ instance_name }}/dashboard" class="btn btn-secondary">üìä Dashboard</a>
    <a href="/instance/{{ instance_name }}/services" class="btn btn-secondary">‚öôÔ∏è Services</a>
</div>
{% endblock %}

{% block content %}
<div class="configs-layout">
    <div class="config-selector">
        <h3>Services der Instanz</h3>
        <div class="config-list">
            <div class="config-item active" onclick="selectGlobalSettings(event)">
                <span class="config-icon">‚ö°</span>
                <span class="config-name">Globale Einstellungen</span>
            </div>
            {% if services|length == 0 %}
            <div class="config-item">
                <span class="config-icon">‚ùå</span>
                <span class="config-name">Keine Services konfiguriert</span>
            </div>
            {% else %}
            {% for service_id, service in services.items() %}
            <div class="config-item" onclick="selectService('{{ service_id }}', event)">
                <span class="config-icon">{{ service.icon or '‚öôÔ∏è' }}</span>
                <span class="config-name">{{ service.name or service_id }}</span>
            </div>
            {% endfor %}
            {% endif %}
        </div>
    </div>

    <div class="config-editor">
        <div class="editor-header">
            <h3 id="editor-title">Service Config</h3>
            <div class="editor-actions">
                <div style="display:flex;gap:0.3rem;margin-right:1rem;">
                    <button id="btn-ic-mode-simple" class="btn btn-primary" onclick="switchICMode('simple')">Simple</button>
                    <button id="btn-ic-mode-expert" class="btn btn-secondary" onclick="switchICMode('expert')">Expert</button>
                </div>
                <button class="btn btn-secondary" onclick="reloadCurrentServiceConfig()">üîÑ Neu laden</button>
                <button class="btn btn-secondary" onclick="showConfigDiff()">üìù Diff</button>
                <button class="btn btn-success" onclick="saveCurrentServiceConfig()">üíæ Speichern</button>
            </div>
        </div>

        <div id="ic-simple-container" class="editor-body" style="padding:1rem;overflow-y:auto;"></div>

        <div class="editor-body">
            <textarea id="config-editor" class="code-editor" spellcheck="false"></textarea>
        </div>

        <div class="editor-footer">
            <div class="editor-info">
                <span class="info-item"><strong>Service:</strong> <code id="service-id">--</code></span>
                <span class="info-item"><strong>Pfad:</strong> <code id="config-path">--</code></span>
                <span class="info-item"><strong>Zeilen:</strong> <span id="line-count">0</span></span>
                <span class="info-item"><strong>Gr√∂√üe:</strong> <span id="file-size">0 KB</span></span>
            </div>
        </div>
    </div>

    <div class="config-info">
        <h3>Validierung</h3>

        <div class="info-section">
            <h4>JSON Status</h4>
            <div id="validation-status" class="status-ok">‚úÖ G√ºltiges JSON</div>
        </div>

        <div class="info-section">
            <h4>Top Keys</h4>
            <div id="config-params" class="params-list"></div>
        </div>

        <div class="info-section">
            <h4>Hinweis</h4>
            <div class="changes-info">
                <p class="info-text">‚ö†Ô∏è Nach Config-√Ñnderung betroffenen Service neu starten.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const currentInstanceName = '{{ instance_name }}';
let currentServiceId = null;
let icMode = 'simple';  // 'simple' or 'expert'
let icCurrentConfig = {};  // parsed config for current service
var usedAudioRegistry = {};  // audio conflict registry
let icAllConfigs = {};  // all service configs for global settings panel
let icGlobalActive = false;  // whether the global settings panel is active

async function initializeInstanceConfig() {
    const editor = document.getElementById('config-editor');
    editor.addEventListener('input', () => {
        validateConfigJSON();
        updateEditorInfo();
    });

    // Load audio devices for Simple mode dropdowns
    await loadAudioDevices();

    // Load Ollama models for model dropdown
    await loadOllamaModels();

    // Load characters for character select dropdown
    await loadCharactersList();

    // Load audio conflict registry
    try {
        const preview = await apiCall('/api/instance/configs/preview', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                services: {{ (instance.services or {})|tojson }},
                editing_instance: currentInstanceName
            })
        });
        usedAudioRegistry = preview.used_audio || {};
    } catch (e) {
        console.warn('Could not load audio registry:', e);
    }

    // Start with Global Settings active
    await selectGlobalSettings(null);
}

async function selectService(serviceId, event) {
    const clickedItem = event && event.currentTarget ? event.currentTarget : null;
    icGlobalActive = false;
    await loadServiceConfig(serviceId, clickedItem);
}

async function selectGlobalSettings(event) {
    icGlobalActive = true;
    currentServiceId = null;

    // Highlight sidebar
    document.querySelectorAll('.config-item').forEach(item => item.classList.remove('active'));
    const clickedItem = event && event.currentTarget ? event.currentTarget :
        document.querySelector('.config-item');
    if (clickedItem) clickedItem.classList.add('active');

    // Hide expert editor, show simple container
    const simpleContainer = document.getElementById('ic-simple-container');
    const editorBody = simpleContainer.nextElementSibling;
    simpleContainer.style.display = '';
    editorBody.style.display = 'none';

    // Update header
    document.getElementById('editor-title').textContent = '‚ö° Globale Einstellungen';
    document.getElementById('service-id').textContent = 'global';
    document.getElementById('config-path').textContent = 'Alle Services';

    // Hide mode toggle buttons (global is always simple)
    document.getElementById('btn-ic-mode-simple').style.display = 'none';
    document.getElementById('btn-ic-mode-expert').style.display = 'none';

    // Load all configs from server
    simpleContainer.innerHTML = '<p style="color:var(--text-muted);">‚è≥ Lade alle Service-Configs...</p>';
    try {
        const result = await apiCall(`/api/instance/${encodeURIComponent(currentInstanceName)}/config/all`);
        icAllConfigs = result.configs || {};
    } catch (e) {
        simpleContainer.innerHTML = `<p style="color:var(--accent-danger);">‚ùå Fehler: ${e.message}</p>`;
        return;
    }

    renderICGlobal();
}

function renderICGlobal() {
    const container = document.getElementById('ic-simple-container');
    if (!container) return;

    const globalHtml = buildGlobalSettingsHtml(icAllConfigs, 'icGlobalFieldChanged');
    container.innerHTML = `
        <div style="border:2px solid var(--accent-primary); border-radius:10px; padding:1.2rem 1.5rem; background:linear-gradient(135deg, rgba(168,85,247,0.08), rgba(59,130,246,0.06));">
            <div style="margin-bottom:1rem;">
                <h4 style="margin:0 0 0.3rem 0; color:var(--accent-primary);">‚ö° Globale Einstellungen</h4>
                <small style="color:var(--text-muted);">Einmal setzen ‚Äì wird automatisch in alle Service-Configs √ºbernommen</small>
            </div>
            <div style="display:grid; gap:0.3rem;">
                ${globalHtml}
            </div>
        </div>`;
}

async function icGlobalFieldChanged(fieldId, value, _onChangeFn) {
    // Call backend to apply global change across all service configs
    try {
        const result = await apiCall(`/api/instance/${encodeURIComponent(currentInstanceName)}/apply-global`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ field_id: fieldId, value: value })
        });

        if (result.success) {
            const count = (result.updated_services || []).length;
            const svcs = (result.updated_services || []).join(', ');
            showNotification(`‚úÖ ${fieldId} aktualisiert ‚Üí ${count} Service${count !== 1 ? 's' : ''}: ${svcs}`, 'success');

            // Reload all configs to reflect changes
            try {
                const refreshed = await apiCall(`/api/instance/${encodeURIComponent(currentInstanceName)}/config/all`);
                icAllConfigs = refreshed.configs || {};
                renderICGlobal();
            } catch (e) {
                console.warn('Could not refresh configs:', e);
            }
        } else {
            showNotification(`‚ùå ${result.error || 'Fehler'}`, 'error');
        }
    } catch (e) {
        showNotification(`‚ùå Netzwerkfehler: ${e.message}`, 'error');
    }
}

async function loadServiceConfig(serviceId, selectedElement = null) {
    if (!serviceId) return;

    if (!confirmDiscardChanges()) return;

    icGlobalActive = false;

    // Restore mode toggle buttons (hidden in global mode)
    document.getElementById('btn-ic-mode-simple').style.display = '';
    document.getElementById('btn-ic-mode-expert').style.display = '';

    document.querySelectorAll('.config-item').forEach(item => item.classList.remove('active'));
    if (selectedElement) selectedElement.classList.add('active');

    try {
        const result = await apiCall(`/api/instance/${encodeURIComponent(currentInstanceName)}/config/service/${encodeURIComponent(serviceId)}`);
        const cfg = result.config || {};

        currentServiceId = serviceId;
        icCurrentConfig = JSON.parse(JSON.stringify(cfg));  // deep copy
        icOriginalConfig = JSON.parse(JSON.stringify(cfg)); // store original for diff
        document.getElementById('service-id').textContent = serviceId;
        document.getElementById('config-path').textContent = result.config_path || '--';
        document.getElementById('editor-title').textContent = `${serviceId} Config`;
        document.getElementById('config-editor').value = JSON.stringify(cfg, null, 2);

        updateEditorInfo();
        validateConfigJSON();
        switchICMode(icMode);  // refresh current mode view
    } catch (error) {
        showNotification(`‚ùå ${error.message}`, 'error');
    }
}

function switchICMode(mode) {
    if (icGlobalActive) return;  // global mode has no expert view
    icMode = mode;
    const btnSimple = document.getElementById('btn-ic-mode-simple');
    const btnExpert = document.getElementById('btn-ic-mode-expert');
    const simpleContainer = document.getElementById('ic-simple-container');
    const editorBody = simpleContainer.nextElementSibling;  // textarea parent

    if (mode === 'simple') {
        btnSimple.className = 'btn btn-primary';
        btnExpert.className = 'btn btn-secondary';
        simpleContainer.style.display = '';
        editorBody.style.display = 'none';
        renderICSimple();
    } else {
        btnSimple.className = 'btn btn-secondary';
        btnExpert.className = 'btn btn-primary';
        simpleContainer.style.display = 'none';
        editorBody.style.display = '';
        // Sync icCurrentConfig -> textarea
        document.getElementById('config-editor').value = JSON.stringify(icCurrentConfig, null, 2);
        updateEditorInfo();
        validateConfigJSON();
    }
}

function setAudioMode(serviceId, mode) {
    audioModePerService[serviceId] = mode;
    if (mode === 'virtual' && currentInstanceName) {
        handleVirtualAudioAssignment(currentInstanceName).then(assignment => {
            if (assignment) {
                // Auto-fill the current service's audio field
                if (currentServiceId === 'main_server') {
                    setNestedValue(icCurrentConfig, 'microphone.device_name', assignment.read_from);
                } else if (currentServiceId === 'text_to_speech') {
                    setNestedValue(icCurrentConfig, 'voicemod.output_name_substring', assignment.write_to);
                }
                document.getElementById('config-editor').value = JSON.stringify(icCurrentConfig, null, 2);
            }
            renderICSimple();
        });
    }
    renderICSimple();
}

function renderICSimple() {
    const container = document.getElementById('ic-simple-container');
    if (!container || !currentServiceId) return;

    const fieldsHtml = buildSimpleFieldsHtml(currentServiceId, icCurrentConfig, {
        usedAudioRegistry: usedAudioRegistry,
        allConfigs: {},
        onChangeCallback: 'icSimpleFieldChanged',
        getConflicts: null,
        instanceName: currentInstanceName,
    });

    container.innerHTML = fieldsHtml || '<p style="color:var(--text-muted);">Keine Simple-Felder f√ºr diesen Service definiert.</p>';
}

function icSimpleFieldChanged(serviceId, path, value, type) {
    if (type === 'number') value = Number(value);
    if (type === 'bool') value = Boolean(value);

    setNestedValue(icCurrentConfig, path, value);
    // Sync to textarea
    document.getElementById('config-editor').value = JSON.stringify(icCurrentConfig, null, 2);
    updateEditorInfo();
    validateConfigJSON();
    renderICSimple();
}

function icSimpleFieldChanged_multi(serviceId, path, fieldId) {
    const values = collectMultiSelectValues(fieldId);
    setNestedValue(icCurrentConfig, path, values);
    // Sync to textarea
    document.getElementById('config-editor').value = JSON.stringify(icCurrentConfig, null, 2);
    updateEditorInfo();
    validateConfigJSON();
}

function confirmDiscardChanges() {
    if (!currentServiceId) return true;
    if (icMode === 'simple') return true;  // Simple mode is always in sync

    const editor = document.getElementById('config-editor');
    if (!editor || !editor.value) return true;

    try {
        JSON.parse(editor.value);
        return true;
    } catch {
        return confirm('Editor enth√§lt ung√ºltiges JSON. Trotzdem wechseln?');
    }
}

async function reloadCurrentServiceConfig() {
    if (icGlobalActive) {
        await selectGlobalSettings(null);
        return;
    }
    if (!currentServiceId) return;
    const active = document.querySelector('.config-item.active');
    await loadServiceConfig(currentServiceId, active);
}

async function saveCurrentServiceConfig() {
    if (icGlobalActive) {
        showNotification('‚ÑπÔ∏è Globale Einstellungen werden sofort beim √Ñndern gespeichert', 'info');
        return;
    }
    if (!currentServiceId) {
        showNotification('‚ùå Kein Service ausgew√§hlt', 'error');
        return;
    }

    let parsed;
    if (icMode === 'simple') {
        parsed = icCurrentConfig;
    } else {
        const editor = document.getElementById('config-editor');
        try {
            parsed = JSON.parse(editor.value);
        } catch (e) {
            showNotification(`‚ùå Ung√ºltiges JSON: ${e.message}`, 'error');
            return;
        }
    }

    try {
        const result = await apiCall(`/api/instance/${encodeURIComponent(currentInstanceName)}/config/service/${encodeURIComponent(currentServiceId)}/save`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(parsed)
        });

        if (result && result.success) {
            showNotification(`‚úÖ ${currentServiceId} Config gespeichert`, 'success');
            icOriginalConfig = JSON.parse(JSON.stringify(parsed));  // update original
            icCurrentConfig = JSON.parse(JSON.stringify(parsed));   // sync
        } else {
            showNotification(`‚ùå ${result.error || 'Speichern fehlgeschlagen'}`, 'error');
        }
    } catch (error) {
        showNotification(`‚ùå ${error.message}`, 'error');
    }
}

// Config Diff View ‚Äî compare original vs current
let icOriginalConfig = {};

function showConfigDiff() {
    if (!currentServiceId) {
        showNotification('Kein Service ausgew√§hlt', 'warning');
        return;
    }

    let current;
    if (icMode === 'simple') {
        current = icCurrentConfig;
    } else {
        try {
            current = JSON.parse(document.getElementById('config-editor').value);
        } catch(e) {
            showNotification('JSON ung√ºltig ‚Äî Diff nicht m√∂glich', 'error');
            return;
        }
    }

    const origStr = JSON.stringify(icOriginalConfig, null, 2).split('\n');
    const currStr = JSON.stringify(current, null, 2).split('\n');
    const maxLen = Math.max(origStr.length, currStr.length);

    let diffHtml = '';
    let hasChanges = false;
    for (let i = 0; i < maxLen; i++) {
        const orig = origStr[i] || '';
        const curr = currStr[i] || '';
        if (orig === curr) {
            diffHtml += `<div style="color:var(--text-muted);font-family:monospace;font-size:0.82rem;padding:1px 0.5rem;">&nbsp; ${escapeHtml(orig)}</div>`;
        } else {
            hasChanges = true;
            if (orig) diffHtml += `<div style="color:#ef4444;background:rgba(239,68,68,0.08);font-family:monospace;font-size:0.82rem;padding:1px 0.5rem;">- ${escapeHtml(orig)}</div>`;
            if (curr) diffHtml += `<div style="color:#10b981;background:rgba(16,185,129,0.08);font-family:monospace;font-size:0.82rem;padding:1px 0.5rem;">+ ${escapeHtml(curr)}</div>`;
        }
    }

    if (!hasChanges) {
        showNotification('Keine √Ñnderungen', 'info');
        return;
    }

    // Show diff in overlay
    let overlay = document.getElementById('diff-overlay');
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'diff-overlay';
        overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;';
        overlay.onclick = (e) => { if (e.target === overlay) overlay.style.display = 'none'; };
        document.body.appendChild(overlay);
    }
    overlay.innerHTML = `
        <div style="background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:12px;padding:1.5rem;max-width:700px;width:90%;max-height:80vh;overflow:auto;box-shadow:var(--shadow-lg);">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
                <h3 style="color:var(--text-primary);margin:0;">üìù Config Diff ‚Äî ${currentServiceId}</h3>
                <button onclick="document.getElementById('diff-overlay').style.display='none'" style="background:none;border:none;color:var(--text-muted);font-size:1.3rem;cursor:pointer;">√ó</button>
            </div>
            <div style="border:1px solid var(--border-color);border-radius:8px;overflow:auto;max-height:60vh;background:var(--bg-primary);padding:0.5rem 0;">
                ${diffHtml}
            </div>
        </div>`;
    overlay.style.display = 'flex';
}

function validateConfigJSON() {
    const editor = document.getElementById('config-editor');
    const statusEl = document.getElementById('validation-status');
    const paramsEl = document.getElementById('config-params');

    if (!editor || !statusEl || !paramsEl) return;

    try {
        const parsed = JSON.parse(editor.value || '{}');
        statusEl.className = 'status-ok';
        statusEl.textContent = '‚úÖ G√ºltiges JSON';

        const keys = Object.keys(parsed).slice(0, 10);
        paramsEl.innerHTML = keys.length
            ? keys.map(key => `<div class="param-item"><strong>${escapeHtml(key)}:</strong> <code>${typeof parsed[key]}</code></div>`).join('')
            : '<div class="param-item">Keine Keys vorhanden</div>';
    } catch (e) {
        statusEl.className = 'status-error';
        statusEl.textContent = `‚ùå ${e.message}`;
        paramsEl.innerHTML = '<div class="param-item" style="color: var(--accent-danger);">JSON-Fehler beheben!</div>';
    }
}

function updateEditorInfo() {
    const editor = document.getElementById('config-editor');
    if (!editor) return;

    const lines = editor.value.split('\n').length;
    const sizeKb = (new Blob([editor.value]).size / 1024).toFixed(2);

    document.getElementById('line-count').textContent = lines;
    document.getElementById('file-size').textContent = `${sizeKb} KB`;
}

function switchToInstance(instanceName) {
    if (instanceName) {
        location.href = `/instance/${encodeURIComponent(instanceName)}/config`;
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

document.addEventListener('DOMContentLoaded', initializeInstanceConfig);
</script>
{% endblock %}
