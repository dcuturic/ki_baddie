{% extends "base.html" %}

{% block page_title %}Einstellungen{% endblock %}
{% block page_subtitle %}Service-Konfigurationen bearbeiten{% endblock %}

{% block content %}
<div class="configs-layout">
    <!-- Config Selector -->
    <div class="config-selector">
        <h3>Instanz</h3>
        <div style="padding: 0 0.5rem 1rem;">
            <select id="instanceSelector" onchange="changeConfigInstance(this.value)" style="width:100%;padding:0.5rem;border-radius:6px;border:2px solid var(--accent-primary);background:var(--bg-secondary);color:var(--text-primary);cursor:pointer;">
                {% for inst in instances %}
                <option value="{{ inst.filename }}" {% if inst.filename == current_instance_name %}selected{% endif %}>
                    {{ inst.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        <h3>Config-Dateien</h3>
        <div class="config-list">
            <div class="config-item active" onclick="selectConfig('manager')">
                <span class="config-icon">‚öôÔ∏è</span>
                <span class="config-name">Manager</span>
            </div>
            {% for service_id, service in config.services.items() %}
            <div class="config-item" onclick="selectConfig('{{ service_id }}')">
                <span class="config-icon">{{ service.icon or 'üì¶' }}</span>
                <span class="config-name">{{ service.name or service_id }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Config Editor -->
    <div class="config-editor">
        <div class="editor-header">
            <h3 id="editor-title">Manager Config</h3>
            <div class="editor-actions">
                <button class="btn btn-secondary" onclick="reloadConfig()">
                    üîÑ Neu laden
                </button>
                <button class="btn btn-success" onclick="saveConfig()">
                    üíæ Speichern
                </button>
            </div>
        </div>
        
        <div class="editor-body">
            <textarea id="config-editor" class="code-editor" spellcheck="false"></textarea>
        </div>
        
        <div class="editor-footer">
            <div class="editor-info">
                <span class="info-item">
                    <strong>Pfad:</strong> <code id="config-path">config.json</code>
                </span>
                <span class="info-item">
                    <strong>Zeilen:</strong> <span id="line-count">0</span>
                </span>
                <span class="info-item">
                    <strong>Gr√∂√üe:</strong> <span id="file-size">0 KB</span>
                </span>
            </div>
        </div>
    </div>
    
    <!-- Config Preview/Validation -->
    <div class="config-info">
        <h3>Informationen</h3>
        
        <div class="info-section">
            <h4>JSON Validation</h4>
            <div id="validation-status" class="status-ok">
                ‚úÖ G√ºltiges JSON
            </div>
        </div>
        
        <div class="info-section">
            <h4>Wichtige Parameter</h4>
            <div id="config-params" class="params-list">
                <!-- Will be populated -->
            </div>
        </div>
        
        <div class="info-section">
            <h4>√Ñnderungen</h4>
            <div class="changes-info">
                <p class="info-text">
                    ‚ö†Ô∏è Nach √Ñnderungen Service neu starten!
                </p>
                <button class="btn btn-sm btn-primary" onclick="restartService()">
                    üîÑ Service neu starten
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const currentInstanceName = '{{ current_instance_name }}';

// Auto-validate JSON on input
document.addEventListener('DOMContentLoaded', () => {
    const editor = document.getElementById('config-editor');
    if (editor) {
        editor.addEventListener('input', () => {
            validateConfigJSON();
            updateEditorInfo();
        });
        
        // Load initial config
        selectConfig('manager');
    }
});

function changeConfigInstance(instanceName) {
    if (instanceName) {
        window.currentInstanceName = instanceName;
        // Reload current config for new instance
        if (currentEditingConfig && currentEditingConfig !== 'manager') {
            selectConfig(currentEditingConfig);
        }
    }
}

// Validate JSON in editor
function validateConfigJSON() {
    const editor = document.getElementById('config-editor');
    const statusEl = document.getElementById('validation-status');
    
    if (!statusEl || !editor) return;
    
    try {
        const parsed = JSON.parse(editor.value);
        statusEl.className = 'status-ok';
        statusEl.textContent = '‚úÖ G√ºltiges JSON';
        
        // Show important keys
        const paramsEl = document.getElementById('config-params');
        if (paramsEl) {
            paramsEl.innerHTML = '';
            const topKeys = Object.keys(parsed).slice(0, 8);
            topKeys.forEach(key => {
                const param = document.createElement('div');
                param.className = 'param-item';
                param.innerHTML = `<strong>${key}:</strong> <code>${typeof parsed[key]}</code>`;
                paramsEl.appendChild(param);
            });
        }
    } catch (e) {
        statusEl.className = 'status-error';
        statusEl.textContent = '‚ùå Fehler: ' + e.message;
        
        const paramsEl = document.getElementById('config-params');
        if (paramsEl) {
            paramsEl.innerHTML = '<div class="param-item" style="color: var(--accent-danger);">JSON-Fehler beheben!</div>';
        }
    }
}

// Update editor info (lines, size)
function updateEditorInfo() {
    const editor = document.getElementById('config-editor');
    if (!editor) return;
    
    const lines = editor.value.split('\n').length;
    const size = (new Blob([editor.value]).size / 1024).toFixed(2);
    
    const lineEl = document.getElementById('line-count');
    const sizeEl = document.getElementById('file-size');
    if (lineEl) lineEl.textContent = lines;
    if (sizeEl) sizeEl.textContent = size + ' KB';
}

// Override selectConfig to use instance-aware config loading
async function selectConfig(configName) {
    const editor = document.getElementById('config-editor');
    if (editor && editor.value !== '') {
        try {
            const currentConfig = JSON.parse(editor.value);
            const inst = document.getElementById('instanceSelector')?.value || currentInstanceName;
            const newConfig = await getConfig(configName, inst);
            if (JSON.stringify(currentConfig) !== JSON.stringify(newConfig)) {
                if (!confirm('Ungespeicherte √Ñnderungen gehen verloren. Fortfahren?')) {
                    return;
                }
            }
        } catch (e) {
            // If current isn't valid JSON, just continue
        }
    }
    
    // Update UI
    document.querySelectorAll('.config-item').forEach(item => {
        item.classList.remove('active');
    });
    if (event && event.target) {
        const item = event.target.closest('.config-item');
        if (item) item.classList.add('active');
    }
    
    // Load new config using instance-aware function
    currentEditingConfig = configName;
    const inst = document.getElementById('instanceSelector')?.value || currentInstanceName;
    window.currentInstanceName = inst;
    const config = await getConfig(configName, inst);
    
    editor.value = JSON.stringify(config, null, 2);
    document.getElementById('editor-title').textContent = configName === 'manager' 
        ? 'Manager Config' 
        : `${configName} Config (${inst})`;
    
    // Resolve config path display
    if (configName === 'manager') {
        document.getElementById('config-path').textContent = 'manager/config.json';
    } else {
        document.getElementById('config-path').textContent = `instance_service_configs/${inst}/${configName}.json`;
    }
    
    updateEditorInfo();
    validateConfigJSON();
}

// Save config
async function saveConfig() {
    const editor = document.getElementById('config-editor');
    if (!editor) return;
    
    try {
        const parsed = JSON.parse(editor.value);
        const inst = document.getElementById('instanceSelector')?.value || currentInstanceName;
        window.currentInstanceName = inst;
        await saveConfiguration(currentEditingConfig, parsed, inst);
    } catch (e) {
        showNotification('‚ùå Ung√ºltiges JSON: ' + e.message, 'error');
    }
}

// Reload config
async function reloadConfig() {
    if (currentEditingConfig) {
        const active = document.querySelector('.config-item.active');
        // Force reload
        const inst = document.getElementById('instanceSelector')?.value || currentInstanceName;
        window.currentInstanceName = inst;
        const config = await getConfig(currentEditingConfig, inst);
        const editor = document.getElementById('config-editor');
        editor.value = JSON.stringify(config, null, 2);
        updateEditorInfo();
        validateConfigJSON();
        showNotification('Config neu geladen', 'success');
    }
}

// Custom notification style for configs
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => notification.classList.add('show'), 10);
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}
</script>
{% endblock %}
